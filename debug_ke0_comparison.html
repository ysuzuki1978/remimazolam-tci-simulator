<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ke0 Comparison Debug</title>
</head>
<body>
    <h1>Ke0 Value Comparison</h1>
    <div id="results"></div>
    
    <script src="utils/masui-ke0-calculator.js"></script>
    <script>
        // Test patient (same as in the screenshots)
        const testPatient = {
            age: 45,
            weight: 70,
            height: 170,
            sex: 'male',
            asaPS: 1
        };
        
        console.log('=== Testing Ke0 Calculation ===');
        console.log('Test patient:', testPatient);
        
        // Calculate PK parameters like InductionEngine does
        const inductionResult = MasuiKe0Calculator.calculateKe0Complete(
            testPatient.age,
            testPatient.weight,
            testPatient.height,
            testPatient.sex,
            testPatient.asaPS
        );
        
        console.log('Induction Engine calculation:');
        console.log('Success:', inductionResult.success);
        console.log('ke0_numerical:', inductionResult.ke0_numerical);
        console.log('ke0_regression:', inductionResult.ke0_regression);
        
        // Apply same fallback logic as InductionEngine
        let inductionKe0 = inductionResult.ke0_numerical;
        if (!inductionKe0 || inductionKe0 <= 0) {
            inductionKe0 = inductionResult.ke0_regression;
        }
        if (!inductionKe0 || inductionKe0 <= 0) {
            console.warn('Invalid ke0 calculated, using default value 0.15');
            inductionKe0 = 0.15;
        }
        
        console.log('Final Induction Engine ke0:', inductionKe0);
        
        // Calculate PK parameters like MonitoringEngine does
        const monitoringResult = MasuiKe0Calculator.calculateKe0Complete(
            testPatient.age,
            testPatient.weight,
            testPatient.height,
            testPatient.sex,
            testPatient.asaPS
        );
        
        console.log('\nMonitoring Engine calculation:');
        console.log('Success:', monitoringResult.success);
        console.log('ke0_numerical:', monitoringResult.ke0_numerical);
        console.log('ke0_regression:', monitoringResult.ke0_regression);
        
        // Apply same fallback logic as MonitoringEngine
        const monitoringKe0 = monitoringResult.ke0_numerical || monitoringResult.ke0_regression;
        
        console.log('Final Monitoring Engine ke0:', monitoringKe0);
        
        // Compare results
        console.log('\n=== COMPARISON ===');
        console.log('Induction Engine ke0:', inductionKe0);
        console.log('Monitoring Engine ke0:', monitoringKe0);
        console.log('Difference:', Math.abs(inductionKe0 - monitoringKe0));
        console.log('Relative difference:', Math.abs(inductionKe0 - monitoringKe0) / Math.max(inductionKe0, monitoringKe0) * 100, '%');
        
        // Display results
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `
            <h2>Results</h2>
            <p><strong>Induction Engine ke0:</strong> ${inductionKe0}</p>
            <p><strong>Monitoring Engine ke0:</strong> ${monitoringKe0}</p>
            <p><strong>Difference:</strong> ${Math.abs(inductionKe0 - monitoringKe0)}</p>
            <p><strong>Relative difference:</strong> ${(Math.abs(inductionKe0 - monitoringKe0) / Math.max(inductionKe0, monitoringKe0) * 100).toFixed(3)}%</p>
            
            <h3>PK Parameters Comparison</h3>
            <table border="1">
                <tr><th>Parameter</th><th>Induction</th><th>Monitoring</th><th>Match</th></tr>
                <tr><td>V1</td><td>${inductionResult.pkParameters.V1}</td><td>${monitoringResult.pkParameters.V1}</td><td>${inductionResult.pkParameters.V1 === monitoringResult.pkParameters.V1}</td></tr>
                <tr><td>k10</td><td>${inductionResult.rateConstants.k10}</td><td>${monitoringResult.rateConstants.k10}</td><td>${inductionResult.rateConstants.k10 === monitoringResult.rateConstants.k10}</td></tr>
                <tr><td>ke0</td><td>${inductionKe0}</td><td>${monitoringKe0}</td><td>${inductionKe0 === monitoringKe0}</td></tr>
            </table>
        `;
    </script>
</body>
</html>